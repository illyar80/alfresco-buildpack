#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
BPACK_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1
CACHE_DIR=$2

# PWD       = /tmp/staged
# BUILD_DIR = /tmp/staged/app
# CACHE_DIR = /tmp/cache
# BINDIR    = /tmp/buildpacks/my-tomcat/bin
# BPACK_DIR = /tmp/buildpacks/my-tomcat

cd $BUILD_DIR

# Install JDL 1.8.0
wget -q --no-check-certificate https://dl.dropboxusercontent.com/u/33282416/alfresco/jdk-8u20-linux-x64.tar.gz
tar zxf jdk-8u20-linux-x64.tar.gz
\rm jdk-8u20-linux-x64.tar.gz
mv jdk1.8.0_20 jdk

# Install Tomcat 7.0.59 and modify its conf/server.xml to accept external parameter as TCP port to bind to
wget -q --no-check-certificate https://dl.dropboxusercontent.com/u/33282416/alfresco/apache-tomcat-7.0.59.tar.gz
tar zxf apache-tomcat-7.0.59.tar.gz
\rm apache-tomcat-7.0.59.tar.gz
\mv apache-tomcat-7.0.59 tomcat
mv tomcat/conf/server.xml tomcat/conf/server.xml.old
cp $BPACK_DIR/files/server.xml tomcat/conf
\rm -rf tomcat/webapps/*
# Download and put alfresco into tomcat
wget -q --no-check-certificate https://dl.dropboxusercontent.com/u/33282416/alfresco/alfresco.war
wget -q --no-check-certificate https://dl.dropboxusercontent.com/u/33282416/alfresco/share.war
#mv share.war tomcat/webapps/

ls -l $BUILD_DIR
ls -l $BUILD_DIR/tomcat/webapps

\rm -rf cmis-browser-app  cmisfs  css  css-boilerplate  favicon.ico  images  index.jsp  jsp  META-INF  scripts  swf  WEB-INF  yui



exit 0
