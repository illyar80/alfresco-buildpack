#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
BPACK_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1
CACHE_DIR=$2

# PWD       = /tmp/staged
# BUILD_DIR = /tmp/staged/app
# CACHE_DIR = /tmp/cache
# BINDIR    = /tmp/buildpacks/my-tomcat/bin
# BPACK_DIR = /tmp/buildpacks/my-tomcat

cd $BUILD_DIR

# Install JDK 1.8.0
echo "Installing JDK 1.8"
wget -q --no-check-certificate https://dl.dropboxusercontent.com/u/33282416/alfresco/jdk-8u20-linux-x64.tar.gz 2>&1 1>& /dev/null
tar zxf jdk-8u20-linux-x64.tar.gz 2>&1 1>& /dev/null
\rm jdk-8u20-linux-x64.tar.gz
mv jdk1.8.0_20 jdk

# Install Tomcat 8 and modify its conf/server.xml to accept external parameter as TCP port to bind to
echo "Installing Tomcat 8"
wget -q --no-check-certificate https://dl.dropboxusercontent.com/u/33282416/alfresco/tomcat8/tomcat8-configured-for-Alfresco.tar.gz 2>&1 1>& /dev/null
tar zxf tomcat8-configured-for-Alfresco.tar.gz 2>&1 1>& /dev/null
\rm tomcat8-configured-for-Alfresco.tar.gz
\mv apache-tomcat-8.0.21 tomcat
mv tomcat/conf/server.xml tomcat/conf/server.xml.old
mv tomcat/conf/context.xml tomcat/conf/context.xml.old
mv tomcat/conf/catalina.properties tomcat/conf/catalina.properties.old
\cp -f $BPACK_DIR/files/server.xml tomcat/conf/ 2>&1 1>& /dev/null
\cp -f $BPACK_DIR/files/context.xml tomcat/conf/ 2>&1 1>& /dev/null
\cp -f $BPACK_DIR/files/catalina.properties tomcat/conf/ 2>&1 1>& /dev/null
mkdir -p tomcat/shared/classes
mkdir -p tomcat/shared/lib
mkdir -p tomcat/endorsed


# Download Alfresco and configure tomcat to run it
echo "Installing Alfresco 5"
cd $BUILD_DIR
wget -q --no-check-certificate https://dl.dropboxusercontent.com/u/33282416/alfresco/alfresco-community-5.0.a.zip 2>&1 1>& /dev/null
unzip alfresco-community-5.0.a.zip 2>&1 1>& /dev/null
\rm alfresco-community-5.0.a.zip
cd alfresco-community-5.0.a 2>&1 1>& /dev/null
cp -R web-server/endorsed/* $BUILD_DIR/tomcat/endorsed/ 2>&1 1>& /dev/null
cp -R web-server/shared/* $BUILD_DIR/tomcat/shared 2>&1 1>& /dev/null
cp -R web-server/lib/* $BUILD_DIR/tomcat/lib 2>&1 1>& /dev/null
cp $BPACK_DIR/files/alfresco-global.properties $BUILD_DIR/tomcat/shared/classes/
cd web-server/webapps/
mkdir tmp
cd tmp
unzip ../alfresco.war 2>&1 1>& /dev/null
cd ..
mv tmp alfresco 
mv alfresco $BUILD_DIR/tomcat/webapps
mkdir tmp
cd tmp
unzip ../share.war 2>&1 1>& /dev/null
cd ..
mv tmp share
mv share $BUILD_DIR/tomcat/webapps
cd $BUILD_DIR 

\rm -rf alfresco-community-5.0.a $BUILD_DIR/simple.war HelloWorld.java WEB-INF

#ls -l $BUILD_DIR
#cat $BUILD_DIR/tomcat/shared/classes/alfresco-global.properties|grep -v ^#

#ls -l $BUILD_DIR/tomcat/shared/classes
#ls -l $BUILD_DIR/tomcat/webapps/
##ls -l $BUILD_DIR/tomcat/shared/lib
#ls -l $BUILD_DIR/tomcat/endorsed

# Compile and install SWF Tools
echo "Building SWF Tools"
mkdir swf-build
cd swf-build
tar zxf $BPACK_DIR/files/bin_deps/swftools-2013-04-09-1007.tar.gz
cd swftools-2013-04-09-1007
./configure --prefix=$BUILD_DIR/swftools  2>&1 1>& /dev/null
make  2>&1 1>& /dev/null; make install  2>&1 1>& /dev/null
cd ../..
\rm -rf swf-build
# Compile and install ImageMagick
echo "Building ImageMagick"
mkdir imgk-build
cd imgk-build
tar jxf $BPACK_DIR/files/bin_deps/ImageMagick-6.9.1-1.tar.bz2 
cd ImageMagick-6.9.1-1
./configure --prefix=$BUILD_DIR/imagemagick --enable-static 2>&1 1>& /dev/null
make  2>&1 1>& /dev/null; make install  2>&1 1>& /dev/null
cd ../..
\rm -rf imgk-build
#ls -l $BUILD_DIR/swftools

exit 0
