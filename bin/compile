#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
BPACK_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1
CACHE_DIR=$2

# PWD       = /tmp/staged
# BUILD_DIR = /tmp/staged/app
# CACHE_DIR = /tmp/cache
# BINDIR    = /tmp/buildpacks/my-tomcat/bin
# BPACK_DIR = /tmp/buildpacks/my-tomcat

cd $BUILD_DIR

# Install JDK 1.8.0
echo "Installing JDK 1.8"
wget -q --no-check-certificate https://dl.dropboxusercontent.com/u/33282416/alfresco/jdk-8u20-linux-x64.tar.gz 2>&1 1>& /dev/null
tar zxf jdk-8u20-linux-x64.tar.gz 2>&1 1>& /dev/null
\rm jdk-8u20-linux-x64.tar.gz
mv jdk1.8.0_20 jdk

# Install Tomcat 8 and modify its conf/server.xml to accept external parameter as TCP port to bind to
echo "Installing Tomcat 8"
wget -q --no-check-certificate https://dl.dropboxusercontent.com/u/33282416/alfresco/tomcat8/tomcat8-configured-for-Alfresco.tar.gz 2>&1 1>& /dev/null
tar zxf tomcat8-configured-for-Alfresco.tar.gz 2>&1 1>& /dev/null
\rm tomcat8-configured-for-Alfresco.tar.gz
\mv apache-tomcat-8.0.21 tomcat
mv tomcat/conf/server.xml tomcat/conf/server.xml.old
mv tomcat/conf/context.xml tomcat/conf/context.xml.old
mv tomcat/conf/catalina.properties tomcat/conf/catalina.properties.old
\cp -f $BPACK_DIR/files/server.xml tomcat/conf/ 2>&1 1>& /dev/null
\cp -f $BPACK_DIR/files/context.xml tomcat/conf/ 2>&1 1>& /dev/null
\cp -f $BPACK_DIR/files/catalina.properties tomcat/conf/ 2>&1 1>& /dev/null
mkdir -p tomcat/shared/classes
mkdir -p tomcat/shared/lib
mkdir -p tomcat/endorsed


# Download Alfresco and configure tomcat to run it
echo "Installing Alfresco 5"
cd $BUILD_DIR
wget -q --no-check-certificate https://dl.dropboxusercontent.com/u/33282416/alfresco/alfresco-community-5.0.a.zip 2>&1 1>& /dev/null
unzip alfresco-community-5.0.a.zip 2>&1 1>& /dev/null
\rm alfresco-community-5.0.a.zip
cd alfresco-community-5.0.a 2>&1 1>& /dev/null
cp -R web-server/endorsed/* $BUILD_DIR/tomcat/endorsed/ 2>&1 1>& /dev/null
cp -R web-server/shared/* $BUILD_DIR/tomcat/shared 2>&1 1>& /dev/null
cp -R web-server/lib/* $BUILD_DIR/tomcat/lib 2>&1 1>& /dev/null
cp $BPACK_DIR/files/alfresco-global.properties $BUILD_DIR/tomcat/shared/classes/
cd web-server/webapps/
mkdir tmp
cd tmp
unzip ../alfresco.war 2>&1 1>& /dev/null
cd ..
mv tmp alfresco 
mv alfresco $BUILD_DIR/tomcat/webapps
mkdir tmp
cd tmp
unzip ../share.war 2>&1 1>& /dev/null
cd ..
mv tmp share
mv share $BUILD_DIR/tomcat/webapps
cd $BUILD_DIR 
\rm -rf alfresco-community-5.0.a $BUILD_DIR/simple.war HelloWorld.java WEB-INF


# Compile and install SWF Tools
echo "Building SWF Tools"
mkdir swf-build
cd swf-build
tar zxf $BPACK_DIR/files/bin_deps/swftools-2013-04-09-1007.tar.gz
cd swftools-2013-04-09-1007
./configure --prefix=$BUILD_DIR/swftools  2>&1 1>& /dev/null
make -j4 2>&1 1>& /dev/null; make install  2>&1 1>& /dev/null
cd ../..
\rm -rf swf-build


# Compile and install ImageMagick
echo "Building ImageMagick"
mkdir imgk-build
cd imgk-build
tar jxf $BPACK_DIR/files/bin_deps/ImageMagick-6.9.1-1.tar.bz2 
cd ImageMagick-6.9.1-1
./configure --prefix=$BUILD_DIR/imagemagick --enable-static 2>&1 1>& /dev/null
make -j4 2>&1 1>& /dev/null; make install  2>&1 1>& /dev/null
cd $BUILD_DIR/imagemagick/bin
mv animate animate.bin
mv compare compare.bin
mv composite composite.bin
mv conjure conjure.bin
mv convert convert.bin
mv display display.bin
mv identify identify.bin
mv import import.bin
mv mogrify mogrify.bin
mv montage montage.bin
mv stream stream.bin

cat << EOF > animate
#!/bin/bash
export LD_LIBRARY_PATH=/home/vcap/app/imagemagick/lib
/home/vcap/app/imagemagick/bin/animate.bin "$@"
EOF

cat << EOF > identify
#!/bin/bash
export LD_LIBRARY_PATH=/home/vcap/app/imagemagick/lib
/home/vcap/app/imagemagick/bin/identify.bin "$@"
EOF

cat << EOF > compare
#!/bin/bash
export LD_LIBRARY_PATH=/home/vcap/app/imagemagick/lib
/home/vcap/app/imagemagick/bin/compare.bin "$@"
EOF

cat << EOF > composite
#!/bin/bash
export LD_LIBRARY_PATH=/home/vcap/app/imagemagick/lib
/home/vcap/app/imagemagick/bin/composite.bin "$@"
EOF

cat << EOF > conjure
#!/bin/bash
export LD_LIBRARY_PATH=/home/vcap/app/imagemagick/lib
/home/vcap/app/imagemagick/bin/conjure.bin "$@"
EOF

cat << EOF > convert
#!/bin/bash
export LD_LIBRARY_PATH=/home/vcap/app/imagemagick/lib
/home/vcap/app/imagemagick/bin/convert.bin "$@"
EOF

cat << EOF > display
#!/bin/bash
export LD_LIBRARY_PATH=/home/vcap/app/imagemagick/lib
/home/vcap/app/imagemagick/bin/display.bin "$@"
EOF

cat << EOF > import
#!/bin/bash
export LD_LIBRARY_PATH=/home/vcap/app/imagemagick/lib
/home/vcap/app/imagemagick/bin/import.bin "$@"
EOF

cat << EOF > mogrify
#!/bin/bash
export LD_LIBRARY_PATH=/home/vcap/app/imagemagick/lib
/home/vcap/app/imagemagick/bin/mogrify.bin "$@"
EOF

cat << EOF > montage
#!/bin/bash
export LD_LIBRARY_PATH=/home/vcap/app/imagemagick/lib
/home/vcap/app/imagemagick/bin/montage.bin "$@"
EOF

cat << EOF > stream
#!/bin/bash
export LD_LIBRARY_PATH=/home/vcap/app/imagemagick/lib
/home/vcap/app/imagemagick/bin/stream.bin "$@"
EOF
chmod +x *

cd ../..
\rm -rf imgk-build

# Install Libreoffice 4.3.6
echo "Downloading Libreoffice 4.3.6 amd64"
mkdir $BUILD_DIR/libreoffice
cd $BUILD_DIR/libreoffice
wget -q --no-check-certificate http://download.documentfoundation.org/libreoffice/stable/4.3.6/deb/x86_64/LibreOffice_4.3.6_Linux_x86-64_deb.tar.gz 2>&1 1>& /dev/null

tar zxvf LibreOffice_4.3.6_Linux_x86-64_deb.tar.gz
\rm LibreOffice_4.3.6_Linux_x86-64_deb.tar.gz
cd LibreOffice_4.3.6.2_Linux_x86-64_deb/DEBS
mkdir tmp

dpkg -x libobasis4.3-base_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-calc_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-core01_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-core02_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-core03_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-core04_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-core05_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-core06_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-core07_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-draw_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-en-us_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-en-us-base_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-en-us-calc_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-en-us-math_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-en-us-res_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-en-us-writer_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-extension-beanshell-script-provider_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-extension-javascript-script-provider_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-extension-mediawiki-publisher_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-extension-nlpsolver_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-extension-pdf-import_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-extension-report-builder_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-filter-data_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-gnome-integration_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-graphicfilter_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-images_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-impress_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-kde-integration_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-librelogo_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-math_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-ogltrans_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-onlineupdate_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-ooofonts_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-ooolinguistic_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-postgresql-sdbc_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-python-script-provider_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-pyuno_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-writer_4.3.6.2-2_amd64.deb tmp/
dpkg -x libobasis4.3-xsltfilter_4.3.6.2-2_amd64.deb tmp/
dpkg -x libreoffice4.3_4.3.6.2-2_amd64.deb tmp/
dpkg -x libreoffice4.3-base_4.3.6.2-2_amd64.deb tmp/
dpkg -x libreoffice4.3-calc_4.3.6.2-2_amd64.deb tmp/
dpkg -x libreoffice4.3-debian-menus_4.3.6-2_all.deb tmp/
dpkg -x libreoffice4.3-dict-en_4.3.6.2-2_amd64.deb tmp/
dpkg -x libreoffice4.3-dict-es_4.3.6.2-2_amd64.deb tmp/
dpkg -x libreoffice4.3-dict-fr_4.3.6.2-2_amd64.deb tmp/
dpkg -x libreoffice4.3-draw_4.3.6.2-2_amd64.deb tmp/
dpkg -x libreoffice4.3-en-us_4.3.6.2-2_amd64.deb tmp/
dpkg -x libreoffice4.3-impress_4.3.6.2-2_amd64.deb tmp/
dpkg -x libreoffice4.3-math_4.3.6.2-2_amd64.deb tmp/
dpkg -x libreoffice4.3-ure_4.3.6.2-2_amd64.deb tmp/
dpkg -x libreoffice4.3-writer_4.3.6.2-2_amd64.deb tmp/

mv tmp/opt/libreoffice4.3 $BUILD_DIR
cd $BUILD_DIR
\rm -rf libreoffice

exit 0
